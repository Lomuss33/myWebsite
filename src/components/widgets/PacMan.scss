@import "/src/styles/extend.scss";

/**
 * Conveyor-belt preloader
 * - keeps the same public API: .pacman-wrapper / .pacman / .pacman-content
 * - keeps the same keyframe names: pacman-content-1/2/3
 * - uses existing DOM structure assumptions:
 *   .pacman-content
 *     > div:nth-child(1)  -> dots/items (3 divs inside, staggered)
 *     > div:nth-child(2)  -> belt/gates  (3 divs inside)
 */

div.pacman-wrapper {
  --size: 100px;

  @include media-breakpoint-down(xxl) { --size: 100px; }
  @include media-breakpoint-down(xl)  { --size: 90px; }
  @include media-breakpoint-down(lg)  { --size: 85px; }
  @include media-breakpoint-down(md)  { --size: 80px; }
  @include media-breakpoint-down(sm)  { --size: 70px; }

  /* Re-using your existing variable names, but for left->right travel */
  --animation-bean-start-position: calc(var(--size) * 0.22);
  --animation-bean-end-position:   calc(var(--size) * 1.10);

  --bean-size: calc(var(--size) * 0.12);

  /* new conveyor sizing */
  --belt-height: calc(var(--size) * 0.28);
  --gate-width:  calc(var(--size) * 0.18);
  --rail-thickness: max(2px, calc(var(--size) * 0.03));

  /* colors via CSS vars so the old variant hook still works */
  --belt-color: #ffffff;
  --dot-color:  #ffffff;

  transition: 0.4s opacity ease-out, 0.4s transform ease-out, 0.4s scale ease-out;
}

div.pacman {
  /* slightly wider than before so the “belt + gates” reads nicely */
  width: calc(var(--size) * 1.45);
  height: var(--size);
  display: inline-block;
  background: transparent;

  /* Keep your existing variant class name, but now it sets variables */
  &-color-variant-loader {
    --belt-color: #{$loader-contrast} !important;
    --dot-color:  #{$primary} !important;
  }
}

div.pacman-wrapper-hidden {
  opacity: 0;
  scale: 0;
  transform: translateY(-120px);
  transition: none;
}

div.pacman-content {
  width: 100%;
  height: 100%;
  position: relative;
  transform: translateZ(0) scale(1);
  backface-visibility: hidden;
  transform-origin: 0 0;
}

div.pacman-content div { box-sizing: content-box; }

/* ------------------------------------------------------------
   BELT + GATES  (pacman-content > div:nth-child(2) ...)
------------------------------------------------------------ */

/* Belt motion (re-using keyframe name pacman-content-1) */
@keyframes pacman-content-1 {
  0%   { background-position: 0 0, 0 0, 0 0; }
  100% { background-position: calc(var(--size) * 0.55) 0, 0 0, 0 0; }
}

/* Gate flap motion (re-using keyframe name pacman-content-2) */
@keyframes pacman-content-2 {
  0%, 100% { transform: rotate(0deg); }
  50%      { transform: rotate(-28deg); }
}

div.pacman-content > div:nth-child(2) {
  position: absolute;
  inset: 0;
}

/* 1) Belt track */
div.pacman-content > div:nth-child(2) div:nth-child(1) {
  position: absolute;
  left: calc(var(--gate-width) * 0.6);
  right: calc(var(--gate-width) * 0.6);
  top: 50%;
  transform: translateY(-50%);
  height: var(--belt-height);
  border-radius: calc(var(--belt-height) / 2);

  /* “belt texture”: moving diagonal stripes + subtle inner depth */
  background:
    repeating-linear-gradient(
      90deg,
      rgba(255,255,255,0.18) 0,
      rgba(255,255,255,0.18) calc(var(--size) * 0.06),
      rgba(255,255,255,0.00) calc(var(--size) * 0.06),
      rgba(255,255,255,0.00) calc(var(--size) * 0.12)
    ),
    linear-gradient(to bottom, rgba(0,0,0,0.20), rgba(0,0,0,0.00) 35%, rgba(0,0,0,0.18)),
    linear-gradient(to right, rgba(0,0,0,0.20), rgba(0,0,0,0.00) 18%, rgba(0,0,0,0.00) 82%, rgba(0,0,0,0.20));

  /* tint using belt-color without losing the texture */
  box-shadow:
    inset 0 0 0 var(--rail-thickness) color-mix(in oklab, var(--belt-color) 75%, #000 25%),
    0 0 0 1px rgba(0,0,0,0.15);

  animation: pacman-content-1 0.9s linear infinite;
}

/* 2) Input gate (left) */
div.pacman-content > div:nth-child(2) div:nth-child(2),
/* 3) Exit gate (right) */
div.pacman-content > div:nth-child(2) div:nth-child(3) {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: var(--gate-width);
  height: calc(var(--belt-height) * 1.25);
  border-radius: 10px;

  /* gate frame */
  box-shadow:
    inset 0 0 0 var(--rail-thickness) color-mix(in oklab, var(--belt-color) 80%, #000 20%),
    0 0 0 1px rgba(0,0,0,0.15);

  background: color-mix(in oklab, var(--belt-color) 16%, transparent);

  /* make them look like “posts” */
  &::before {
    content: "";
    position: absolute;
    inset: calc(var(--rail-thickness) * 1.2);
    border-radius: 8px;
    background: rgba(0,0,0,0.18);
    opacity: 0.25;
  }

  /* flap/door */
  &::after {
    content: "";
    position: absolute;
    left: 50%;
    top: 50%;
    width: calc(var(--gate-width) * 0.75);
    height: calc(var(--belt-height) * 0.20);
    transform-origin: left center;
    transform: translate(-50%, -50%) rotate(0deg);
    border-radius: 999px;
    background: var(--belt-color);
    opacity: 0.95;
  }
}

/* Left gate position + flap animation */
div.pacman-content > div:nth-child(2) div:nth-child(2) {
  left: 0;

  &::after {
    animation: pacman-content-2 0.9s ease-in-out infinite;
  }
}

/* Right gate position + mirrored flap animation */
div.pacman-content > div:nth-child(2) div:nth-child(3) {
  right: 0;

  &::after {
    /* mirror: rotate opposite direction */
    transform-origin: right center;
    animation: pacman-content-2 0.9s ease-in-out infinite reverse;
  }
}

/* ------------------------------------------------------------
   DOTS / ITEMS (pacman-content > div:nth-child(1) ...)
------------------------------------------------------------ */

/* Dot travel (re-using keyframe name pacman-content-3) */
@keyframes pacman-content-3 {
  0%   { transform: translateX(var(--animation-bean-start-position)); opacity: 0; }
  15%  { opacity: 1; }
  100% { transform: translateX(var(--animation-bean-end-position)); opacity: 1; }
}

div.pacman-content > div:nth-child(1) {
  display: block;
}

/* Each dot */
div.pacman-content > div:nth-child(1) div {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);

  /* keep your bean size var, just render as “packages/dots” */
  width: calc(var(--bean-size) * 1.05);
  height: var(--bean-size);
  border-radius: 999px;

  background: var(--dot-color);

  /* sit on the belt track */
  margin-top: 0;
  box-shadow:
    0 0 0 1px rgba(0,0,0,0.25),
    0 2px 0 rgba(0,0,0,0.18);

  animation: pacman-content-3 0.9s linear infinite;
}

/* keep your existing staggering pattern */
div.pacman-content > div:nth-child(1) div:nth-child(1) { animation-delay: -0.60s; }
div.pacman-content > div:nth-child(1) div:nth-child(2) { animation-delay: -0.30s; }
div.pacman-content > div:nth-child(1) div:nth-child(3) { animation-delay:  0.00s; }